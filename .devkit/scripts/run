#!/usr/bin/env bash
set -e

# Function to log to stderr
log() {
    echo "$@" >&2
}

# Check if context parameter is provided
if [ -z "$1" ]; then
    log "Error: Missing context parameter"
    log "Usage: ./run '{\"version\":\"0.0.1\",\"context\":{...}}'"
    exit 1
fi

# Parse the JSON context
CONTEXT="$1"

# Check for required tools
if ! command -v jq &> /dev/null; then
    log "Error: jq not found. Please run 'avs create' first."
    exit 1
fi

if ! command -v docker &> /dev/null; then
    log "Error: Docker is not running or not installed. Please start Docker and try again."
    exit 1
fi

# Extract required values from context
ENVIRONMENT=$(echo "$CONTEXT" | jq -r '.context.name')

# Validate required fields exist in JSON
if [ "$ENVIRONMENT" == "null" ] || [ -z "$ENVIRONMENT" ]; then
    log "Error: Missing name (environment) in context"
    exit 1
fi

log "Starting AVS components for environment: $ENVIRONMENT"

# Run the Aggregator and Executor in docker containers
./.hourglass/scripts/run.sh

log "AVS components started successfully." 
