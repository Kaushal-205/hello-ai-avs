#!/usr/bin/env bash
set -e

# source in helper functions
source "$( dirname "${BASH_SOURCE[0]}" )/helpers/helpers.sh"

# Check if required tools are available
ensureMake
ensureForge
ensureDocker

# Build the contracts and dependencies
log "Building AVS performer..."
BUILD_CONTAINER=true ./.hourglass/scripts/build.sh >&2

# Get the image name from build.yaml
IMAGE_NAME=$(yq eval '.container.image' .hourglass/build.yaml)
REGISTRY=$(yq eval '.container.registry' .hourglass/build.yaml)
VERSION=$(yq eval '.container.version' .hourglass/build.yaml)

# Construct the full image name
if [ -z "$REGISTRY" ]; then
    FULL_IMAGE_NAME="ghcr.io/${IMAGE_NAME}:${VERSION}"
    REGISTRY_URL="ghcr.io"
else
    FULL_IMAGE_NAME="${REGISTRY}/${IMAGE_NAME}:${VERSION}"
    REGISTRY_URL="${REGISTRY}"
fi

# Get the container digest of the specific image
log "Getting container digest..."
DIGEST=$(docker inspect "$FULL_IMAGE_NAME" --format='{{.Id}}')

log "Updated artifacts field in file with digest: $DIGEST"
log "Building contracts..."
cd .devkit/contracts && forge clean && forge build -- --include ../../contracts/**/*.sol >&2

# Create and output the JSON structure
RESULT=$(jq -n \
    --arg digest "$DIGEST" \
    --arg registry "$REGISTRY_URL" \
    '{
        artifacts: {
            image_digest: $digest,
            registry_url: $registry
        }
    }')

# Print the JSON to stdout
echo "$RESULT" | jq -c .

log "Build completed successfully."